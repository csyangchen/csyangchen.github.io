---
title: factorio游戏引发的思考
published: false
---

[factorio](https://en.wikipedia.org/wiki/Factorio)
是个工厂模拟游戏, 奔着适合程序员的评价, 体验了一把.
这里记录下一些想法.

# 供需计算

游戏里面除了提供材料的直接材料依赖, 还很贴心的计算了基于最原始材料的数量和耗时, 最简单情况按原始材料数量准备好, 直接生产即可.
可是工厂不像主角那样全能, 能直接计算依赖按需生产多样产品; 此外, 很多物品不能靠主角手搓出来, 必须依赖工厂.
最重要的一点, 主角虽然能手搓物品, 但是只能单点运行, 需要通过各种专门工厂并行生产, 才能提高生产效率.

问题可以表述为, 给定一个物品目标生产速率, 测算需要多少种工厂, 以及每种工厂需要多少个.

具体例子, 已知

1发动机需1齿轮2铁管1钢材10秒
1齿轮需2铁片0.5秒
1铁管需1铁片0.5秒
1钢材需炼炉5铁片16秒
1铁片需炼炉1矿石3.2秒
1矿石需钻机0.25时0.3秒

则1发动机需原材料4铁片1钢材, 即9铁片.
需发动机工厂, 齿轮工厂, 铁管工厂, 钢材炼炉, 铁片炼炉, 铁矿钻机共6种工厂.
1铁片炼炉, 10秒内只能生产约3(10/3.2)铁片, 不够1个发动机工厂全速生产发动机, 需3个才能满足(3.2*9/10),
同样的, 如果只有1钢材炼炉, 无法全速生产发动机, 要每生产10秒等6秒; 而2钢材炼炉, 则会产生冗余钢材.

> CODE

通过依赖计算, 可以测算一个或者一批物品按照指定速率生产, 需要依赖多少上游工厂以及数量. 做一个简单的供需测算器.
游戏的最终目标, 不论是不停的放卫星, 还是万瓶工厂, 等等, 对各种物品的生产速率的要求, 其实就已经确定下来了.

# 背包问题

以上讨论假设了只有一种工厂生产速率, 实际上游戏里面有不同类型工厂以及加速包, 从而提供不同的生产速率.
我们每种中间产物不能做到刚好消耗, 会产生冗余.
因此这里我们可以通过调配不同工厂组合生产的策略, 从而最小化冗余物品输出.
假设两种工厂, A型生产速率3, B型生产速率7, 需求速率为11时, 则最优组合为4A(12) < 2A1B(13) < 2B(14).
如果我们目标是禁止浪费, 那么只能牺牲生产速率, 取一个最接近需求速率的结果, 即1A1B(10).

视作一个背包问题, 看需要目标选择合适的组合.

# 精益生产

背包组合的办法没有办法杜绝浪费, 实际游戏中的办法, 也就是游戏最基本的机制, 就是下游堵塞时停止生产.
实际设计时, 每种物品的管线或者模块, 只要能够达到目标需要的生产速率即可.

精益生产也要求避免中间过程的浪费, 如在中间物流系统中的物品也视作浪费, 这要求我们对于整体物流的路径做最短规划.

# 物流网络

工厂确定好后, 剩下的问题就是工厂间物品的流动, 即物流网络.

每个工厂视为节点, 根据依赖关系构建出传送带/管道网络边即可.
游戏允许管道的交叉, 即允许边与边的相交, 因此实际设计中, 只要空间留的足够宽, 不存在连不上的问题.
如果不允许边的交叉, 则表述为平面图 (planar graph) 问题, 这在游戏的复杂依赖中基本不可行. 

# 环岛物流

一种简单的想法, 就是所有物品在一个环形的传送带上, 每个工厂用抓钩拾取需要的物品生产, 并把输出直接丢回到传送带上.
只要这个环岛足够粗, 就能满足一切传输速率需求.

然而实际的情况是, 一些物品的过度生产会最终堵塞整个传送带, 从而导致整个系统的罢工.
即便没有堵塞, 抓钩的工作速度会成为传送带的瓶颈, 导致每个工厂绝大部分时间处于等待输入完整状态.
输出也是丢回原传送带, 也会遇到堵塞输出状态.

能想到的补偿办法是, 每个下环岛的线路额外增加缓冲区, 确保环路保持高速不堵塞.
对于堆积的冗余物品, 需要设计精准的监控以及及时下环岛的链路, 这个实践起来挺难, 也许通过游戏中的相关自动化机制可以实现.

# 总线物流

为了避免不同类型物品同管线堆积互相干扰, 一般每种物品使用专属的传送带, 即物品总线.
每个工厂生产需要几样材料, 就总线分流引几条传送带进来, 并将输出丢回到对应的物品总线上.
每条物品线冗余堆积后自然停止生产, 不影响其他物品的流动.

再考虑到可扩展性需求, 一个整体的总线, 横贯东西的传送带走廊. 有几种物品, 就修几条传送带.
走廊北面, 工厂纵向布局, 从而支持生产的扩容.
走廊南面, 做北行交通设计, 及传送带的扩容.
不同物品的传送速率需求, 可以通过不断增加同物品传送带数量解决.

与总线对应的词是专线, 字面理解就是两个工厂私有的线路, 好处是保障高不受其他影响, 缺陷是每两个依赖工厂拉专线, 复杂度高不易实现.

# 最短线型图

在满足可行性, 以及所需传输带宽前提下, 物流网络的设计目标需要尽可能短, 以实现精益.

游戏中, 物流传送带, 抓钩, 以及工厂都有占地要求.
整体最小占地的设计, 不等同于最短物流设计, 但是实践中基本可以视为等价.
游戏里面甚至设计了专门的限制空间的设计挑战.

环线结构, 可以忽略物品生产依赖关系, 因为物品最终转一圈会去到目的地.
总线结构下, 确保依赖物品工厂在上游(即西边)即可.

在总线模式下, 如何决定工厂顺序, 从而最小化物品的平均传输距离. 此为最短线型图规划问题.

给定一个图, 一定是可以线性化为一条直线的, 每个点的宽度确定条件下, 求所有边按照权重加起来最短.

> CODE

具体到生活中的例子, 如厨房中的物品需要如何摆放, 确保做饭的时候动线最短.

也可以考虑二维图的整体最短路径设计, 不过在整体总线结构下, 我们只讨论一维.

# 可扩展性 / 敏捷

可扩展性: 固定目标, 提升量级

敏捷: 目标变更了

好的设计是能够简单扩展的, 或者能过快速应对变化需求的.

可扩展性一般是好解决的, 直接水品扩容, 即复制粘贴既有设计就好.

可扩展性几乎永远适合其他目标是冲突的, 如可扩展的物流网络一定不是最短的, 这个需要找折中.

敏捷, 换句话说, 就是每种物品的需求完全变更也能快速支持到. 一般和可扩展性矛盾.
最敏捷的办法是所有工厂全部通过机器人物流, 这样指哪儿打哪儿, 但是物流带宽远不如传送带高效.

# 垂直扩容VS水平扩容

为了满足不断增长的下游需求

单个工厂生产速率提升, 高级工厂替换, 或者增加模块组件, 从而实现垂直扩容.
增加同工厂的数量, 谓之水平扩容. 

传送带也可以垂直扩容, 但是只有3选项. 传送带可以并联实现水平扩容, 缺点就是需要挤占横向空间, 需要非常提早规划.

在总线结构下, 在一条生产线, 不断的北向加工厂, 也是另外一种意义上的"垂直扩容". 东西向扩建一个相同的生产线, 谓之水平扩容.

单工厂层面的扩容不是问题, 问题是扩容后的物流设计.
生产线的垂直扩容到一定阶段后, 一定会导致对应传送带的不足.
因此需要针对具体的生产物品分析, 以决定生产线的最大垂直扩容深度, 并预留足够的水平扩容空间.

# 缓冲

游戏中有不同的缓冲手段, 如传送带, 储物箱.
缓冲是为了缓解生产和消费临时性的错配, 或者是调度灵活生产的一种手段.

# 效率

很有意思的一个工厂模块是通过降低20%消费速率提升10%产量, 乍看上去挺没用的功能, 测算下来生产速率反而降低了. 价值何在?
在后期生产已经不是瓶颈, 瓶颈在物流上, 通过降低对于单位产量的原料需求, 从而缓解上游的物流需求;
换个角度看, 同样的物流, 可以支持更多的消费模块, 通过水平扩容的手段, 达到整体更高的产出速率.

# 供需不足还是资源错配

资源调配是个全局问题

生产A需要B和C, 观察到B不足后扩容B产线, 结果发现A的生产并没有提高, 反而C不足了,  
因为B和C的上游都依赖于D, 本质上是D的供给不足了.

# 改变才是唯一不变

如果一开始目标就是确定的, 那么解法是确定的.
但是随着不断解锁新的科技和选项, 每个阶段的目标不断变化, 

适配之前目标的结构不再适用, 需要快速调整适配新的目标.

当然如果只看最终目标, 每个阶段的分段目标都可以考量到后续的步骤.

# 物流机器人的路劲规划问题

物流机器人省去了管线设计和优化, 但是对于目标多个物品的时候, 如何最短路径送完, 也是个有意思的问题.

不同于一笔画问题, 这里允许重复走路.

# 模块化设计与花纹美学

模块需要能够天然的快速组合, 二维扩展或者一维扩展.

输入输出口相邻原则, 从而再需要垂直或者水平扩展的时候不用大费周章调整到其他关联部分.

因此一个简单的生产线原则为左边自下而上的输入线, 右边自上往下的输出线, 扩容时直接向上延展即可.

瓷砖花纹设计要求能够自然的平滑拼接.

# 封装的边界

职责单一还是强耦合

当两个相邻AB生产线, 左边输出恰好为右边输入时, 很有动力去做个到U型链接, 但是这样强绑定了两条产线, B产线堆积时候, A也跟着堆积, B产线消费过快时, 其他依赖A的下游饿死.

类似的问题

CPU vs GPU

微服务结构 vs 蜂巢结构

封装的边界, 封装的层级愈高, 这个模块性能越容易提升, 封装的层级越低, 越容易组合满足新的需求.

# 游戏性与外部压力

对于一个确定的布局 (主要是原材料产地位置),
一个确定的最终目标, 最终解法不说唯一, 至少一定是确定的, 那么这个游戏性就很差.

地图探索机制, 用未知性和不断发现新资源环节, 提高游戏性.

常见游戏里面的随机性, 该作中基本不涉及.

此外虫族的入侵等随机事件, 也增加了时间随机性, 并给到了外部压力, 即在最终生产目标和地域外部压力两个目标中间找平衡.

# 通关模式

每个阶段有个固定目标, 没完成则淘汰, 但是提前完成可以选择提前交卷, 还是用挣出来的余量为下一步做好准备.
短期目标和长期目标的取舍.