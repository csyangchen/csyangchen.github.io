---
title: factorio游戏引发的思考
published: false
---

factorio是个工厂模拟游戏, 奔着杀时间适合程序员的评价, 体验了一把, 引发了不少思考, 以及和其他事务的联系

# 供需测算

游戏里面除了告诉了制作的材料依赖, 还很贴心的计算了基于最原始材料的数量和耗时.
最情况就是按原始材料配比做好输入, 直接生产物品即可, 可是工厂不像主角那样能直接计算依赖按需生产多样产品.
以及很多物品不能靠主角手搓出来, 必须依赖工厂.
否则, 备齐最基础原料后, 主角原地手搓就好了, 当然这个耗时一定时巨大到不可行的.
需要通过专样化工厂并行生产, 以提升需求物品的生产效率.

因此给定一个物品生产, 需要测算需要多少种工厂, 以及每种工厂需要多少个, 才能确保该物品生产不饥饿.

例如,
1发动机需1齿轮2铁管1钢材10时
1齿轮需2铁片0.5时
1铁管需1铁片0.5时
1钢材需炼炉5铁片16时
1铁片需炼炉1矿石3.2时
1矿石需钻机0.25时0.3时

因此, 生产发动机需发动机工厂, 齿轮工厂, 铁管工厂, 钢材炼炉, 铁片炼炉, 铁矿钻机共6种工厂.
1发动机需4铁片1钢材, 即9铁片.
如只有1铁片炼炉, 10时内只能生产约3(10/3.2)铁片, 不够全速生产发动机, 需3个才能满足(3.2*9/10),
同样的, 如果只有1钢材炼炉, 无法全速生产发动机, 要每生产10秒等6秒, 而2钢材炼炉, 则会产生冗余的钢材.

再复杂一点, 为了不停的放卫星, 对于各种物品的生产速率提出了要求.

因此, 通过依赖计算, 可以测算一个或者一批物品按照指定速率生产, 需要依赖多少上游工厂以及数量. 做一个简单的供需测算器.

> CODE

游戏里面科研也有依赖关系, 只是去掉了数量依赖, 
科研消耗颜料瓶物品, 同样也可以视为一种特殊的无形的物品生产.
因此同样计算为了达到指定科研水平所以来的原材料数量, 以及为了最速科研的工厂设计.
当然游戏机制里面同时只能允许一项科研, 极大简化了这部分的复杂度.


# 背包问题

以上只是讨论了一种工厂的生产速率, 实际上游戏里面有不同类型工厂以及加速包, 从而提供不同的生产速率.
我们每种胜场的材料不能做到刚好消耗, 会产生冗余, 这里我们可以通过调配不同工厂组合生产的策略, 从而最小化冗余物品输出.

假设两类工厂, A生产速率3, B生产速率7, 需求速率为11时, 则最优组合为4A(12) < 2A1B(13) < 2B(14)
如果我们禁止生产浪费, 那么只能牺牲生产速率, 取一个最接近需求速率的结果 1A1B(10)

这个就是典型的背包问题

# 环岛寿司结构

一种简单的想法就是所有物品在一个环形的传送带上, 每个工厂用抓钩加筛选获得需要的物品生产, 并把产品丢回到传送带上.
通过调整每种工厂的比例, 从而实现完美的流转.

然而现实是, 总有一些物品的过度生产, 最终占满并堵塞了整个传送带, 导致所有的工厂停工.
此外抓钩的工作速度成为了瓶颈, 每个工厂绝大部分时间处于等待输入完整状态.
以及产出也是丢回原传送带, 也会遇到堵塞输出状态.

# 总线

为了避免不同类型物品堆积的问题, 总线的办法, 即每种物品专属的传送带, 每个工厂生产需要几样材料, 就分流引几条传送带进来, 目前看上去最多的也就三种材料, 加上一个输出, 用四个抓钩即可解决输入输出问题.
此外每条生产线饱和后不再消费, 天然的被压机制.

因此, 一个理想的情况为, 横贯东西的传送带走廊. 有多少中物品, 就有多少条传送带.
在走廊北面, 是每种物品的专项生产线, 在走廊南面, 编织对应改生产线物流的专门下高速通道.
理解为快速路, 每遇到一个出口, 就修个高架, 出口物品靠右然后左转.

设计为环线可以直接忽略物品的依赖关系, 缺点是从生产到消费, 中间是整个总线长度;
可以工厂顺序设计, 从而确保上有工厂一定在西边, 并通过计算, 寻找最短依存顺序.

由于游戏机制里地下传送通道的长度限制, 这里南部区域的错线极为复杂.

# 一条线最优依赖布局

一条线的布局是最为简单的容易

一条线结构, 最短依赖距离.

由于每种工厂依赖的原料不同, 如果希望物品只往一个方向流动, 则工厂需按照依赖顺序排列.

线性图 / linear graph

此外为了尽可能减少距离, 依赖的工厂总距离需尽可能的短.

当然也可以考虑二维网格化的最短路径, 不过不便于横向扩展.

# 垂直扩容VS水平扩容

为了满足不断增长的下游需求, 

对于单个工厂生产速率提升, 高级工厂替换, 或者增加模块组件, 从而实现垂直扩容

对于一个生产线的提升, 不断的复制工厂数即可.

不过去到一定阶段后, 传送带成为了瓶颈. 一种是确保左右均衡, 充分利用一条传送带的两侧带宽.

单个传送带不断拉长的缺点, 前面的输出堆积, 而后面的输入不足.

传送带也可以垂直扩容, 但是只有3个选项. 

传送带并排实现水平扩容, 缺点就是需要挤占横向空间, 需要非常提早规划.

看在何种层面上做水平扩容.

# 提升效率是关键

里面很有意思的一个模块是通过降低20%消费速率提升10%产量, 乍看上去挺没用的功能, 测算下来生产速率反而降低了. 价值何在?
在后期生产已经不是瓶颈, 瓶颈在物流上, 通过降低对于单位产量的原料需求, 从而缓解上游的物流需求;
换个角度看, 同样的物流, 可以支持更多的消费模块, 通过水平扩容的手段, 达到整体更高的产出速率.

# 是供需不足还是资源错配

资源调配是个全局问题

生产A需要B和C, 观察到B不足后扩容B产线, 结果发现A的生产并没有提高, 反而C不足了,  
因为B和C的上游都依赖于D, 本质上是D的供给不足了.

# 改变才是唯一不变

如果一开始目标就是确定的, 那么解法是确定的.
但是随着不断解锁新的科技和选项, 每个阶段的目标不断变化, 

适配之前目标的结构不再适用, 需要快速调整适配新的目标.

当然如果只看最终目标, 每个阶段的分段目标都可以考量到后续的步骤.

# 精益生产

从结果倒推, 按需生产, 从而减少浪费.

管线铺的太长, 导致大量的中间物件堆积在管线上, 这些都是可见的浪费.

物流机器人解决了管线堆积的问题.

# 物流一笔画问题

物流机器人省去了管线设计和优化, 但是对于目标多个物品的时候, 如何最短路径送完.

虽然游戏里面物流机器人一次只能传输一种物品, 这个问题任值得记录.

不同于一笔画问题, 这里允许重复走路.

一维上的一笔画问题就很简单, 出发位置在目标位置左边, 就从做到右再去到目标点...

二维图上问题 TODO.

# 瓷砖花纹形式的设计

模块需要能够天然的快速组合, 二维扩展或者一维扩展.

输入输出口相邻原则, 从而再需要垂直或者水平扩展的时候不用大费周章调整到其他关联部分.

因此一个简单的生产线原则为左边自下而上的输入线, 右边自上往下的输出线, 扩容时直接向上延展即可.

# 避免耦合

当两个相邻AB生产线, 左边输出恰好为右边输入时, 很有动力去做个到U型链接, 但是这样强绑定了两条产线, B产线堆积时候, A也跟着堆积, B产线消费过快时, 其他依赖A的下游饿死.

CPU vs GPU

# 敏捷还是固化优化

当变化频繁的时候, 职责单一, 能够快速适配是首要目标.

而当目标确定时候, 则不用考量了, 对每个固定模块强耦合, 可以达到更好的效率. 如直接串联上下游, 减少总线压力.

# 职责单一

不要混线生产

# 游戏性与外部压力

对于一个确定的布局, 和一个确定的最终目标, 最终解法不说唯一, 至少一定是确定的, 那么游戏性就很差.

通过引入地图探索不断发现新资源环节, 来提高未知性.

此外虫族的入侵等随机事件, 也增加了时间随机性, 并给到了外部压力, 即在最终生产目标和地域外部压力两个目标中间找平衡.

# 通关模式

每个阶段有个固定目标, 没完成则淘汰, 但是提前完成可以选择提前交卷, 还是用挣出来的余量为下一步做好准备.
短期目标和长期目标的取舍.