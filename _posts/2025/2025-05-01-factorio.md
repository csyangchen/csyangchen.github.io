---
title: factorio游戏引发的思考
published: false
---

[factorio](https://en.wikipedia.org/wiki/Factorio)
是个工厂模拟游戏, 奔着适合程序员的评价, 体验了一把.
这里记录下一些想法.

# 供需计算

所谓生产, 就是一些物品输入, 花点时间, 输出一些物品. 游戏里采集, 科研, 等, 也可以视为生产过程. 
生产配方列出了所需的材料和单位生产耗时, 所需材料亦需要通过其配方生产出来, 从而构建了一个复杂的物品生产依赖关系.
游戏里贴心的计算了基于最原始材料的数量和耗时, 最简单办法按原始材料数量准备好, 主角直接原地手搓即可.
不过主角手搓物品只是临时补缺的备用手段, 如果所有东西靠手搓, 耗时是不可接受的.
因此需要引入工厂, 同时生产多种物品.
此外, 一些物品不能主角手搓, 必须依赖工厂才可生产.

一个自然的供需测算问题, 即需要每种工厂各多少个, 才能达成指定物品的计划生产速率.

具体例子, 已知配方

1发动机需1齿轮2铁管1钢材10秒
1齿轮需2铁片0.5秒
1铁管需1铁片0.5秒
1钢材需炼炉5铁片16秒
1铁片需炼炉1矿石3.2秒
1矿石需钻机0.25时0.3秒

则1发动机需原材料4铁片1钢材, 即9铁片.
需发动机工厂, 齿轮工厂, 铁管工厂, 钢材炼炉, 铁片炼炉, 铁矿钻机共6种工厂.
1铁片炼炉, 10秒内只能生产约3(10/3.2)铁片, 不够1个发动机工厂全速生产发动机, 需3个才能满足(3.2*9/10),
同样的, 如果只有1钢材炼炉, 无法全速生产发动机, 要每生产10秒等6秒; 而2钢材炼炉, 则会产生冗余钢材.

> CODE

通过依赖计算, 可以知晓所需的工厂以及数量.
游戏的最终目标, 不论是不停的放卫星, 还是万瓶工厂, 等等, 一旦确定, 对各中间物品的生产速率要求, 其实就已经确定下来了.

# 精益生产

我们每种中间物品不能做到刚好消耗, 会产生冗余. 游戏中最基本的机制, 就是下游堵塞时停止生产.

游戏里面有不同类型工厂以及加速包, 从而提供不同的生产速率.
我们可以通过调配不同工厂组合生产的策略, 从而最小化冗余物品输出.
假设AB两种工厂生产速率分别为3和7, 需求生产速率为11时, 则最优组合为4A(12) < 2A1B(13) < 2B(14).

可以视作一个背包问题, 看需要目标选择合适的组合.

背包组合的办法没有办法杜绝浪费.

游戏中最基本的机制, 就是下游堵塞时停止生产.
实际设计时, 每种物品的管线或者模块, 只要能够达到目标需要的生产速率即可.

精益生产也要求避免中间过程的浪费, 如在中间物流系统中的物品也视作浪费, 这要求我们对于整体物流的路径做最短规划.

# 物流网络

工厂确定好后, 剩下的问题就是工厂间物品的流动, 即物流网络.

每个工厂视为节点, 根据依赖关系构建出传送带/管道网络边即可.
游戏允许管道的交叉, 即允许边与边的相交, 因此实际设计中, 只要空间留的足够宽, 不存在连不上的问题.
如果不允许边的交叉, 则表述为平面图 (planar graph) 问题, 这在游戏的复杂依赖中基本不可行. 

# 环岛物流

一种简单的想法, 就是所有物品在一个环形的传送带上, 每个工厂用抓钩拾取需要的物品生产, 并把输出直接丢回到传送带上.
只要这个环岛足够粗, 就能满足一切传输速率需求.

然而实际的情况是, 一些物品的过度生产会最终堵塞整个传送带, 从而导致整个系统的罢工.
即便没有堵塞, 抓钩的工作速度会成为传送带的瓶颈, 导致每个工厂绝大部分时间处于等待输入完整状态.
输出也是丢回原传送带, 也会遇到堵塞输出状态.

能想到的补偿办法是, 每个下环岛的线路额外增加缓冲区, 确保环路保持高速不堵塞.
对于堆积的冗余物品, 需要设计精准的监控以及及时下环岛的链路, 这个实践起来挺难, 也许通过游戏中的相关自动化机制可以实现.

# 总线物流

物流, 物品流动

为了避免不同类型物品同管线堆积互相干扰, 一般每种物品使用专属的传送带, 即物品总线.
每个工厂生产需要几样材料, 就总线分流引几条传送带进来, 并将输出丢回到对应的物品总线上.
每条物品线冗余堆积后自然停止生产, 不影响其他物品的流动.

再考虑到可扩展性需求, 一个整体的总线, 横贯东西的传送带走廊. 有几种物品, 就修几条传送带.
走廊北面, 工厂纵向布局, 从而支持生产的扩容.
走廊南面, 做北行交通设计, 及传送带的扩容.
不同物品的传送速率需求, 可以通过不断增加同物品传送带数量解决.

与总线对应的词是专线, 字面理解就是两个工厂私有的线路, 好处是保障高不受其他影响, 缺陷是每两个依赖工厂拉专线, 复杂度高不易实现.

# 最短布局

物流网络的设计目标需要尽可能短, 以实现精益. 这里优化的目标是在整个物流网络中的物品数量.

简单起见, 我们只考虑一维横向物流布局, 工厂做纵向扩展.
每种工厂视作节点, 传送带视作边.
节点权重为工厂的占地宽度, 边的权重为传输带宽, 或者说传输速率.

如果只允许单向的布局, 那么不能达到最短.
简单例子: A=3, B=3, C=3, AB=10, BC=10, 最短布局应该为A<-B->C, 但不是单向物流.

## 单向物流最短布局

构建每个工厂的被依赖

# 最小空间布局

更一般的情况, 是考虑二维图上整体最短布局, 或者更合适的说法是最小空间布局.
因为目标确定后, 每个工厂模块的占地是确定的.

任何策略性游戏, 布局都是很重要的因素. 在满足功能性要求下, 尽可能的占地少, 从而节约一些建筑材料, 或者易于防守等.

这里只考虑工厂依赖是比较简单的, 更复杂一点的依赖, 如加速器对于二维范围内生效, 电力的覆盖也是二维约束.

# 垂直扩容VS水平扩容

为了满足不断增长的下游需求

单个工厂生产速率提升, 高级工厂替换, 或者增加模块组件, 从而实现垂直扩容.
增加同工厂的数量, 谓之水平扩容. 

传送带也可以垂直扩容, 但是只有3选项. 传送带可以并联实现水平扩容, 缺点就是需要挤占横向空间, 需要非常提早规划.

在总线结构下, 在一条生产线, 不断的北向加工厂, 也是另外一种意义上的"垂直扩容". 东西向扩建一个相同的生产线, 谓之水平扩容.

单工厂层面的扩容不是问题, 问题是扩容后的物流设计.
生产线的垂直扩容到一定阶段后, 一定会导致对应传送带的不足.
因此需要针对具体的生产物品分析, 以决定生产线的最大垂直扩容深度, 并预留足够的水平扩容空间.

# 缓冲

游戏中有不同的缓冲手段, 如传送带, 储物箱.
缓冲是为了缓解生产和消费临时性的错配, 或者是调度灵活生产的一种手段.

# 效率

很有意思的一个工厂模块是通过降低20%消费速率提升10%产量, 乍看上去挺没用的功能, 测算下来生产速率反而降低了. 价值何在?
在后期生产已经不是瓶颈, 瓶颈在物流上, 通过降低对于单位产量的原料需求, 从而缓解上游的物流需求;
换个角度看, 同样的物流, 可以支持更多的消费模块, 通过水平扩容的手段, 达到整体更高的产出速率.

# 供需不足还是资源错配

资源调配是个全局问题

生产A需要B和C, 观察到B不足后扩容B产线, 结果发现A的生产并没有提高, 反而C不足了,  
因为B和C的上游都依赖于D, 本质上是D的供给不足了.

# 改变才是唯一不变

如果一开始目标就是确定的, 那么解法是确定的.
但是随着不断解锁新的科技和选项, 每个阶段的目标不断变化, 

适配之前目标的结构不再适用, 需要快速调整适配新的目标.

当然如果只看最终目标, 每个阶段的分段目标都可以考量到后续的步骤.

# 机器人物流的路径规划问题

游戏里除了管道物流, 后期还有机器人物流网络.

物流机器人省去了管线设计和优化, 但是对于目标多个物品的时候, 如何最短路径送完, 也是个有意思的问题.

不同于一笔画问题, 这里允许重复走路.

# 可扩展性 / 敏捷

可扩展性: 固定目标, 提升量级

敏捷: 目标变更了

好的设计是能够简单扩展的, 或者能过快速应对变化需求的.

可扩展性一般是好解决的, 直接水品扩容, 即复制粘贴既有设计就好.

可扩展性几乎永远适合其他目标是冲突的, 如可扩展的物流网络一定不是最短的, 这个需要找折中.

敏捷, 换句话说, 就是每种物品的需求完全变更也能快速支持到. 一般和可扩展性矛盾.
最敏捷的办法是所有工厂全部通过机器人物流, 这样指哪儿打哪儿, 但是物流带宽远不如传送带高效.

## 模块化设计与花纹美学

模块需要能够天然的快速组合, 二维扩展或者一维扩展.

输入输出口相邻原则, 从而再需要垂直或者水平扩展的时候不用大费周章调整到其他关联部分.

因此一个简单的生产线原则为左边自下而上的输入线, 右边自上往下的输出线, 扩容时直接向上延展即可.

瓷砖花纹设计要求能够自然的平滑拼接.

# 封装的边界

职责单一还是强耦合

当两个相邻AB生产线, 左边输出恰好为右边输入时, 很有动力去做个到U型链接, 但是这样强绑定了两条产线, B产线堆积时候, A也跟着堆积, B产线消费过快时, 其他依赖A的下游饿死.

类似的问题

CPU vs GPU

微服务结构 vs 蜂巢结构

封装的边界, 封装的层级愈高, 这个模块性能越容易提升, 封装的层级越低, 越容易组合满足新的需求.

# 火车运输带宽

最终传输效率最高的一定是火车, 一则忽略掉启停过程, 火车的极速很高且能不断升级.
其次火车的带宽是车厢的长度, 可以不断的扩展.

# 游戏性与外部压力

对于一个确定的布局 (主要是原材料产地位置),
一个确定的最终目标, 最终解法不说唯一, 至少一定是确定的, 那么这个游戏性就很差.

地图探索机制, 用未知性和不断发现新资源环节, 提高游戏性.

常见游戏里面的随机性, 该作中基本不涉及.

此外虫族的入侵等随机事件, 也增加了时间随机性, 并给到了外部压力, 即在最终生产目标和地域外部压力两个目标中间找平衡.

# 通关模式

游戏里面还有个通关模式, 
即每阶段有个固定目标, 没完成则淘汰, 提前完成可以有额外奖励.
这里需要决策是提前交卷还是利用该阶段冗余的时间为下一阶段做做些准备.

# 三通一平 / 网格布局

类似于现实世界中政府招商引资, 先要开发区平整地面, 通水通电通路, 在游戏后期, 一种具体生产目标无关的设计, 按照物流机器人的最大范围边界, 构建全覆盖的建筑机器人网络, 实现通电.
在网格边界按照最高标准(单向4车道/传送带)修路. 每个网格, 或者说标准化地块按需调整.